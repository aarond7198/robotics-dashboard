<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Project Tracker</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9f9f9; }
  .topbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
  .topbar .btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; background: #e8eef9; color: #0b5ed7; }
  .spacer { flex: 1; }
  .project { margin-bottom: 40px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); position: relative; }
  .project-header { font-weight: bold; font-size: 18px; margin-bottom: 8px; }
  .project-subheader { font-size: 13px; color: #666; margin-bottom: 12px; }
  .timeline { display: flex; flex-wrap: nowrap; gap: 6px; overflow-x: auto; background: #eee; border-radius: 6px; padding: 6px; position: relative; font-size: 10px; min-height: 120px; align-items: stretch; }
  .timeline-item { background: white; padding: 8px 8px 6px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); min-width: 110px; text-align: center; position: relative; cursor: pointer; transition: opacity 0.2s ease; }
  .timeline-item.dragging { opacity: 0.35; }
  .timeline-item.completed { opacity: 0.5; }
  .timeline-item span.icon { font-size: 16px; display: block; margin-bottom: 4px; }
  .task-name { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
  .timeline-label { font-size: 10px; line-height: 1.2; }
  .task-meta { font-size: 9px; color: #666; margin-top: 2px; min-height: 12px; }
  .timeline-item.final-invoice .timeline-label { display: none; }
  .total-hours { margin-top: 8px; font-weight: bold; font-size: 13px; }
  .green { color: green; } .blue { color: blue; } .orange { color: orange; }
  #new-project-btn { margin-bottom: 20px; padding: 10px 20px; background: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 15px; }
  .edit-btn { float: right; font-size: 11px; background: none; border: none; color: #007BFF; cursor: pointer; }

  /* SMALLER + ABOVE MODALS */
  #context-menu {
    position: absolute;
    display: none;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 10000;
    padding: 4px;
    border-radius: 6px;
    font-size: 12px;
    min-width: 160px;
  }
  #context-menu div { padding: 4px 8px; cursor: pointer; }
  #context-menu div:hover { background: #f0f0f0; }

  .current-tag { position: absolute; left: -6px; top: 6px; bottom: 6px; width: 4px; background: #007BFF; border-radius: 4px; }
  .current-text { position: absolute; left: -26px; top: 6px; font-size: 9px; writing-mode: vertical-rl; text-orientation: mixed; color: #007BFF; font-weight: 700; letter-spacing: 0.5px; user-select: none; }

  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 2000; }
  .modal { background: #fff; width: 800px; max-width: calc(100% - 32px); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
  /* Wider only for the Assignments modal */
  .modal.assignments-modal { width: 1200px; max-width: calc(100% - 32px); }
  @media (max-width: 1300px) {
    .modal.assignments-modal { width: 95vw; }
  }

  .modal-header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
  .modal-body { padding: 12px 16px; max-height: 60vh; overflow: auto; }
  .modal-footer { padding: 10px 16px; border-top: 1px solid #eee; display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px; align-items: center; }
  .modal-close { background: none; border: none; font-size: 18px; cursor: pointer; }
  .btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
  .btn-primary { background: #007BFF; color: #fff; }
  .btn-ghost { background: transparent; color: #007BFF; }
  .btn-icon { padding: 6px 8px; font-size: 12px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; cursor: pointer; }

  .subtask-list { display: flex; flex-direction: column; gap: 8px; }
  .subtask-chip { display: grid; grid-template-columns: 1fr; gap: 8px; align-items: center; }
  .chip-bar-wrap { background: #f3f3f3; border-radius: 999px; height: 16px; position: relative; overflow: hidden; display: flex; align-items: center; padding: 0 8px; }
  .chip-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: #d0e3ff; transition: width 0.15s ease; }
  .chip-label { position: relative; z-index: 1; font-size: 11px; white-space: normal; }
  .chip-actions { display: none; }

  .summary-hours { font-size: 12px; display: flex; gap: 14px; flex-wrap: wrap; }
  .summary-hours b { font-weight: 700; }

  .subtask-dashes { display:flex; justify-content:center; align-items:center; gap:4px; margin-top:6px; min-height: 6px; }
  .subtask-dashes .dash { width:10px; height:2px; background:#bbb; border-radius:1px; }

  .invoice-badge { display:inline-block; margin-top:4px; padding:2px 6px; font-size:10px; border-radius:10px; background:#fff4d6; color:#8a5a00; border:1px solid #f0d28a; }

  #loadingOverlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.95); z-index: 3000; font-size: 16px; font-weight: 700; color: #333; pointer-events: all; }
  .spinner { width: 18px; height: 18px; border: 3px solid #cfd4e0; border-top-color: #007BFF; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  #viewBadge { position: fixed; top: 10px; right: 12px; background:#222; color:#fff; font-size:11px; padding:6px 8px; border-radius: 6px; opacity: .85; z-index: 4000; display:none; }

  body.ro #saveGoogleBtn,
  body.ro #new-project-btn,
  body.ro #settingsBtn,
  body.ro .edit-btn,
  body.ro #ready-invoice-btn,
  body.ro #risk-btn { display: none !important; }

  .settings-section-title { font-weight:700; margin-top:14px; }
  .reorder-list { margin-top:6px; display:flex; flex-direction:column; gap:6px; }
  .re-item { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #e2e2e2; border-radius:8px; background:#fafafa; cursor: grab; user-select:none; }
  .re-item:active { cursor: grabbing; }
  .re-handle { font-size:14px; opacity:.6; }
  .re-name { font-size:12px; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .re-ghost { opacity:.5; }

  .drop-indicator { width: 5px; background: #0b5ed7; border-radius: 3px; align-self: stretch; box-shadow: 0 0 0 2px rgba(11,94,215,0.15); }

  /* Assignments modal UI */
  .assn-bar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
  .assn-chip { padding:4px 8px; border:1px solid #ddd; border-radius:999px; cursor:pointer; font-size:12px; background:#fafafa; user-select:none; }
  .assn-chip.active { background:#0b5ed7; color:#fff; border-color:#0b5ed7; }
  .assn-chip.disabled { opacity:.5; cursor:default; }
  .assn-search { min-width:220px; padding:6px; border:1px solid #ddd; border-radius:6px; font-size:12px; }
  .assn-table { width:100%; border-collapse:collapse; font-size:12px; }
  .assn-table th, .assn-table td { border:1px solid #eee; padding:6px 8px; text-align:left; }
  .assn-table th { background:#f7f7f7; position:sticky; top:0; z-index:1; }
  .assn-actions { display:flex; gap:6px; flex-wrap:wrap; }
  .assn-note { font-size:11px; color:#666; margin-top:4px; }

  /* Settings Tabs */
  .tabs { display:flex; gap:6px; border-bottom:1px solid #eee; margin: -4px -16px 12px; padding: 0 16px; position: sticky; top: 0; background: #fff; z-index: 1; }
  .tab-btn { padding:8px 12px; border-radius:8px 8px 0 0; border:1px solid transparent; background:transparent; cursor:pointer; font-size:13px; }
  .tab-btn.active { background:#f7f9ff; border-color:#dbe5ff; border-bottom-color:#f7f9ff; color:#0b5ed7; }
  .tab-pane { display:none; }
  .tab-pane.active { display:block; }

  /* Default Timeline editor rows */
  .dtl-row { display:grid; grid-template-columns: 18px 1.4fr 1fr 0.9fr auto; align-items:center; gap:8px; padding:6px 8px; border:1px solid #e2e2e2; border-radius:8px; background:#fafafa; }
  .dtl-grab { cursor: grab; opacity: .6; }
  .dtl-row input[type="text"] { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; font-size:12px; }
  .dtl-row select { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; font-size:12px; }
  .dtl-row input[type="number"] { width:100%; padding:6px; border:1px solid #ddd; border-radius:6px; font-size:12px; }
  .dtl-actions { display:flex; gap:6px; justify-content:flex-end; }
  .dtl-help { font-size:11px; color:#666; margin:6px 0 0; }
  .dtl-list { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
  .dtl-ghost { opacity:.5; }
  .dtl-muted { color:#888; font-size:11px; margin-top:6px; }
  .dtl-inline-note { font-size:11px; color:#666; }
  @media print {
    body { background: #fff; padding: 0; }
    .topbar, #context-menu, #loadingOverlay, #viewBadge, .modal-backdrop { display: none !important; }
    #new-project-btn { display: none !important; }
    .project { page-break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
    @page { size: 11in 8.5in; margin: 0.5in; }
  }
</style>
</head>
<body>
  <div class="topbar">
    <button id="saveGoogleBtn" class="btn">üíæ Save (Google)</button>
    <button id="loadGoogleBtn" class="btn">‚ü≥ Load (Google)</button>
    <button id="printBtn" class="btn">üñ®Ô∏è Export PDF (Letter, Fit)</button>
    <button id="printTabloidBtn" class="btn">üñ®Ô∏è Export PDF 11√ó17 (Fit)</button>
    <span class="spacer"></span>
    <button id="assignmentsBtn" class="btn">üë• Assignments</button>
    <button id="settingsBtn" class="btn">‚öôÔ∏è Settings</button>
  </div>

  <button id="new-project-btn">+ New Project</button>
  <div id="project-container"></div>
  <div id="context-menu"></div>
  <div id="viewBadge">VIEW ONLY</div>

  <div id="loadingOverlay"><div class="spinner"></div>Loading from Google‚Ä¶</div>

  <!-- Subtask Modal -->
  <div id="subtask-modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="subtask-modal-title">
      <div class="modal-header">
        <div id="subtask-modal-title">Subtasks</div>
        <button id="subtask-modal-close" class="modal-close" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="subtask-rows" class="subtask-list"></div>
        <div id="add-subtask-wrap" style="margin-top:12px;">
          <button id="add-subtask-btn" class="btn btn-ghost">+ Add Subtask</button>
        </div>
      </div>
      <div class="modal-footer">
        <div class="summary-hours" id="modal-summary">
          <span><b>Base:</b> 0</span>
          <span><b>Subtasks:</b> 0</span>
          <span><b>Total:</b> 0</span>
        </div>
        <button id="ready-invoice-btn" class="btn" style="display:none;">Ready to Invoice‚Ä¶</button>
        <button id="risk-btn" class="btn" style="display:none;">Create Risk Assessment‚Ä¶</button>
        <button id="subtask-modal-done" class="btn btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Invoice Email Modal -->
  <div id="invoice-modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="invoice-modal-title">
      <div class="modal-header">
        <div id="invoice-modal-title">Ready to Invoice</div>
        <button id="invoice-modal-close" class="modal-close" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="display:grid; gap:8px;">
          <label>Subject
            <input id="invoice-subject" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;">
          </label>
          <label>Body
            <textarea id="invoice-body" rows="10" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></textarea>
          </label>
        </div>
      </div>
      <div class="modal-footer" style="grid-template-columns:auto auto auto;">
        <button id="invoice-copy" class="btn">Copy Body</button>
        <button id="invoice-open-mail" class="btn">Open Email</button>
        <button id="invoice-complete" class="btn btn-primary">Mark Sent & Complete</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal (Tabbed) -->
  <div id="settings-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="modal-header">
        <div id="settings-title">Settings</div>
        <button id="settings-close" class="modal-close" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- Tabs -->
        <div class="tabs" id="settings-tabs">
          <button class="tab-btn" data-tab="tab-order">Project Order</button>
          <button class="tab-btn" data-tab="tab-invoice">Invoice Contacts</button>
          <button class="tab-btn" data-tab="tab-timeline">Default Timeline</button>
          <button class="tab-btn" data-tab="tab-risk">Risk Assessment</button>
        </div>

        <!-- Project Order -->
        <div class="tab-pane" id="tab-order">
          <div class="settings-section-title">Project Order</div>
          <div id="proj-order-wrap">
            <div id="proj-order-list" class="reorder-list"></div>
            <div style="font-size:11px; color:#666; margin-top:4px;">Drag to change display/save order.</div>
          </div>
        </div>

        <!-- Invoice Contacts -->
        <div class="tab-pane" id="tab-invoice">
          <div class="settings-section-title">Invoice Contacts</div>
          <div style="display:grid; gap:10px;">
            <label>Primary Invoice Name
              <input id="set-primary-name" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;">
            </label>
            <label>Primary Invoice Email
              <input id="set-primary-email" type="email" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;">
            </label>
            <label>Final/Closeout Name
              <input id="set-final-name" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;">
            </label>
            <label>Final/Closeout Email
              <input id="set-final-email" type="email" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;">
            </label>
          </div>
        </div>

        <!-- Default Timeline -->
        <div class="tab-pane" id="tab-timeline">
          <div class="settings-section-title">Default Timeline</div>
          <div class="dtl-inline-note">This template is used when you choose ‚ÄúAdd default timeline template‚Äù while creating a new project.</div>
          <div class="dtl-actions" style="margin-top:8px;">
            <button id="dtl-add" class="btn">+ Add Step</button>
            <button id="dtl-reset" class="btn btn-ghost">Reset to Recommended</button>
          </div>
          <div id="dtl-list" class="dtl-list"></div>
          <div class="dtl-help">Fields: <b>Name</b>, <b>Category</b> (Task, Invoice, External), and optional <b>Invoice %</b> (visible when Category = Invoice). Drag ‚ò∞ to reorder.</div>
        </div>

        <!-- Risk Assessment -->
        <div class="tab-pane" id="tab-risk">
          <div class="settings-section-title">Risk Assessment</div>
          <div style="display:grid; gap:10px;">
            <label>GitHub XLSM URL (blob or raw)
              <input id="set-risk-github" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;"
                     placeholder="https://github.com/&lt;owner&gt;/&lt;repo&gt;/blob/main/path/file.xlsm">
              <div style="font-size:11px; color:#666; margin-top:4px;">
                Paste a public repo URL. We auto-convert to <code>raw.githubusercontent.com</code> for download.
              </div>
            </label>
            <label>Filename Pattern
              <input id="set-risk-pattern" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;"
                     placeholder="[Customer] [Project] Risk Assessment [YYYY-MM-DD].xlsm">
              <div style="font-size:11px; color:#666; margin-top:4px;">
                Tokens: [Customer] [Project] [Application] [SalesOrder] [PO] [Robot] [YYYY] [MM] [DD] [YYYY-MM-DD] [MM-DD-YYYY] [MM DD YYYY]
              </div>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="grid-template-columns:1fr auto;">
        <div></div>
        <button id="settings-save" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Date/Duration Editor Modal -->
  <div id="date-modal-backdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="date-modal-title">
      <div class="modal-header">
        <div id="date-modal-title">Set Date / Duration</div>
        <button id="date-modal-close" class="modal-close" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="display:grid; gap:10px;">
          <label>Pick a Date
            <input id="date-input" type="date" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;">
          </label>
          <div style="text-align:center; color:#888; font-size:12px;">‚Äî or ‚Äî</div>
          <label>Duration (optional)
            <input id="dur-input" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:6px;" placeholder="e.g., 10d, 2w, 1mo">
            <div style="font-size: 11px; color:#666;">Use <b>d</b>=days, <b>w</b>=weeks, <b>mo</b>=months.</div>
          </label>
        </div>
      </div>
      <div class="modal-footer" style="grid-template-columns:auto auto auto;">
        <button id="date-clear" class="btn">Clear</button>
        <button id="date-cancel" class="btn">Cancel</button>
        <button id="date-save" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- NEW: Assignments Modal -->
  <div id="assignments-backdrop" class="modal-backdrop">
    <!-- ADDED .assignments-modal to widen only this modal -->
    <div class="modal assignments-modal" role="dialog" aria-modal="true" aria-labelledby="assignments-title">
      <div class="modal-header">
        <div id="assignments-title">Assignments</div>
        <button id="assignments-close" class="modal-close" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="assn-bar" id="assn-owner-chips"></div>
        <div class="assn-bar">
          <label style="font-size:12px;">Show:
            <select id="assn-status" style="margin-left:6px; padding:4px 6px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
              <option value="open">Open only</option>
              <option value="completed">Completed only</option>
              <option value="all">All</option>
            </select>
          </label>
          <input id="assn-search" class="assn-search" placeholder="Search project / task / subtask">
          <div class="assn-note">Tip: Click a row‚Äôs ‚ûú Open to jump to the card.</div>
        </div>

        <div class="summary-hours" id="assn-summary"></div>

        <div style="overflow:auto; border:1px solid #eee; border-radius:8px; max-height:44vh;">
          <table class="assn-table" id="assn-table">
            <thead>
              <tr>
                <th style="min-width:120px;">Owner</th>
                <th style="min-width:160px;">Project</th>
                <th style="min-width:160px;">Task</th>
                <th style="min-width:180px;">Subtask</th>
                <th style="min-width:80px;">Hours</th>
                <th style="min-width:80px;">Done</th>
                <th style="min-width:200px;">Actions</th>
              </tr>
            </thead>
            <tbody id="assn-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer" style="grid-template-columns:auto auto auto;">
        <button id="assn-copy" class="btn">Copy CSV</button>
        <button id="assn-print" class="btn">Print</button>
        <button id="assn-close" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

<script>
/* Google URL */
const GOOGLE_URL = 'https://script.google.com/macros/s/AKfycbws6zd3ifawAHUR3equN29KD5dULQ0blgUmekwycLibEJHg4MjO_V_BAMX0DbIv8P3lWg/exec';

/* View-only flag via URL */
const READ_ONLY = (() => {
  const q = new URLSearchParams(location.search);
  const v = (q.get('view') || q.get('readonly') || q.get('ro') || '').toLowerCase();
  return v === '1' || v === 'true' || v === 'yes';
})();

/* Ensure ro class never lingers between sessions */
if (READ_ONLY) {
  document.documentElement.classList.add('ro');
  document.body.classList.add('ro');
} else {
  document.documentElement.classList.remove('ro');
  document.body.classList.remove('ro');
}

/* --- Default Timeline (recommended fallback) --- */
const DEFAULT_TIMELINE = [
  { name: 'DP Invoice', category: 'Invoice', invoicePercent: 50 },
  { name: 'Kickoff', category: 'Task' },
  { name: 'Design', category: 'Task' },
  { name: 'Manufacture', category: 'External' },
  { name: 'Assy & Prep', category: 'Task' },
  { name: 'PreInstall Prep', category: 'External' },
  { name: 'Pre Ship Invoice', category: 'Invoice', invoicePercent: 35 },
  { name: 'Ship', category: 'Task' },
  { name: 'Install', category: 'Task' },
  { name: 'Risk Assessment', category: 'Task' },
  { name: 'Final Invoice', category: 'Invoice', invoicePercent: 15 }
];

/* Settings (stored via Google; no localStorage) */
const Settings = {
  data: {
    primaryName: 'Katie',
    primaryEmail: 'kmason@gogcg.com',
    finalName: 'Zach',
    finalEmail: 'zschuchardt@gogcg.com',

    /* Risk Assessment download settings */
    riskGithubUrl: '',
    riskFileNamePattern: '[Customer] [Project] Risk Assessment [YYYY-MM-DD].xlsm',

    /* Editable default timeline */
    defaultTimeline: []   // falls back to DEFAULT_TIMELINE if empty
  },
  load() { /* no-op */ },
  save() { /* no-op */ }
};
Settings.load();

let hasLocalEdits = false;
const markDirty = ()=> { if (!READ_ONLY) hasLocalEdits = true; };

const contextMenu = document.getElementById('context-menu');
const loadingOverlay = document.getElementById('loadingOverlay');
const viewBadge = document.getElementById('viewBadge');
const showLoading = (on)=> { loadingOverlay.style.display = on ? 'flex' : 'none'; };

/* --- Global hardening in READ_ONLY mode --- */
if (READ_ONLY) {
  document.addEventListener('dragstart', e => { e.preventDefault(); }, true);
  document.addEventListener('contextmenu', e => {
    if (e.target.closest('.timeline') || e.target.closest('.timeline-item') || e.target.closest('.edit-btn')) {
      e.preventDefault();
    }
  }, true);
  document.addEventListener('keydown', e => {
    const isSave = (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's';
    const isDelete = e.key === 'Delete' || e.key === 'Backspace';
    if (isSave || isDelete) { e.preventDefault(); }
  }, true);
}

let dragged = null;
let dragOriginTimeline = null;
let dropIndicator = null;

document.addEventListener('click', (e) => { if (!contextMenu.contains(e.target)) contextMenu.style.display = 'none'; });

function normalizeCategory(c){ if(!c) return 'Task'; const v=String(c).trim().toLowerCase(); if(v==='customer'||v==='external') return 'External'; if(v==='invoice') return 'Invoice'; return 'Task'; }
function normalizeRobot(r){ const v=String(r||'').trim().toLowerCase(); if (v==='ur') return 'UR'; if (v==='fanuc') return 'Fanuc'; return ''; }

/* Robot-aware icon */
function categoryIcon(category, robotResolved){
  const c=normalizeCategory(category);
  if (c==='Invoice') return ['$', 'green'];
  if (c==='External') return ['‚öë', 'orange'];
  const color = (robotResolved==='Fanuc') ? 'green' : 'blue';
  return ['‚ñ†', color];
}

/* ---------- Header helpers ---------- */
function formatSubheader({robot='', customer='', application='', salesOrder='', poNumber='', estDate=''}) {
  const rob = normalizeRobot(robot) || 'UR';
  return `Robot: ${rob} | Customer: ${customer} | Application: ${application} | Sales Order: ${salesOrder} | PO: ${poNumber} | Est. Completion: ${estDate}`;
}
function parseSubheaderText(text) {
  const obj = { robot:'', customer:'', application:'', salesOrder:'', poNumber:'', estDate:'' };
  const parts = String(text||'').split('|').map(s=>s.trim());
  parts.forEach(seg=>{
    const m = seg.match(/^([^:]+):\s*(.*)$/);
    const key = m ? m[1].toLowerCase() : '';
    const val = m ? (m[2] || '') : '';
    if (key.startsWith('robot')) obj.robot = val;
    else if (key.startsWith('customer')) obj.customer = val;
    else if (key.startsWith('application')) obj.application = val;
    else if (key.startsWith('sales order')) obj.salesOrder = val;
    else if (key === 'po' || key.startsWith('po ')) obj.poNumber = val;
    else if (key.startsWith('est. completion')) obj.estDate = val;
  });
  return obj;
}

/* ---------- Date helpers ---------- */
function pad2(n){ return String(n).padStart(2,'0'); }
function formatDateShort(iso){
  if (!iso) return ''; const p = String(iso).split('-'); if (p.length!==3) return '';
  return `${p[1]}/${p[2]}`;
}
function parseDateOrDuration(input){
  const s = String(input||'').trim();
  if (!s) return { iso:'', label:'', days:null };
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return { iso:s, label:formatDateShort(s), days:null };
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?$/);
  if (m){
    const mm = Math.max(1, Math.min(12, parseInt(m[1],10)));
    const dd = Math.max(1, Math.min(31, parseInt(m[2],10)));
    const year = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
    const yyyy = year < 100 ? 2000 + year : year;
    const d = new Date(yyyy, mm-1, dd);
    if (!isNaN(d)) {
      const iso = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      return { iso, label:`${pad2(mm)}/${pad2(dd)}`, days:null };
    }
  }
  m = s.match(/^\s*(\d+)\s*(d|w|mo)\s*$/i);
  if (m){
    const n = parseInt(m[1],10);
    const unit = m[2].toLowerCase();
    const days = unit==='d' ? n : unit==='w' ? n*7 : n==='mo' ? n*30 : n*30;
    const label = unit==='d' ? `${n}d` : unit==='w' ? `${n}w` : `${n}mo`;
    return { iso:'', label, days };
  }
  return { iso:'', label:s, days:null };
}
function isoToMillisLocal(iso){
  const m = String(iso||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return NaN;
  const y = +m[1], mo = +m[2]-1, d=+m[3];
  return new Date(y, mo, d).getTime();
}
function daysToLabel(d){
  if (d%30===0) return `${d/30}mo`;
  if (d%7===0) return `${Math.round(d/7)}w`;
  return `${d}d`;
}
function subtaskLabel(st){ return st.date ? formatDateShort(st.date) : (st.dateText||''); }

/* Compute meta label from ALL subtasks */
function bestTaskDateLabel(taskElem){
  const selfLabel = taskElem.dataset.date ? formatDateShort(taskElem.dataset.date)
                   : (taskElem.dataset.dateText || '');
  if (selfLabel) return selfLabel;

  const subs = taskElem._subtasks || [];
  if (!subs.length) return '';

  const abs = subs.filter(s=>s.date).map(s=>isoToMillisLocal(s.date)).filter(t=>isFinite(t));
  if (abs.length){
    const min = Math.min(...abs), max = Math.max(...abs);
    const dMin = new Date(min), dMax = new Date(max);
    const lMin = `${pad2(dMin.getMonth()+1)}/${pad2(dMin.getDate())}`;
    const lMax = `${pad2(dMax.getMonth()+1)}/${pad2(dMax.getDate())}`;
    return (min===max) ? lMin : `${lMin}‚Äì${lMax}`;
  }

  const durs = subs.map(s=>{
    if (!s.dateText) return null;
    const m = s.dateText.match(/^\s*(\d+)\s*(d|w|mo)\s*$/i);
    if (!m) return null;
    const n = parseInt(m[1],10), u=m[2].toLowerCase();
    return u==='d'?n : u==='w'?n*7 : u==='mo'?n*30:null;
  }).filter(v=>v!==null);

  if (durs.length){
    const min = Math.min(...durs), max = Math.max(...durs);
    return (min===max) ? daysToLabel(min) : `${daysToLabel(min)}‚Äì${daysToLabel(max)}`;
  }

  for (const s of subs){
    const L = subtaskLabel(s);
    if (L) return L;
  }
  return '';
}

/* Subtask dashes */
function updateSubtaskDashes(taskElem){
  let wrap = taskElem.querySelector('.subtask-dashes');
  if (!wrap) { wrap = document.createElement('div'); wrap.className = 'subtask-dashes'; taskElem.appendChild(wrap); }
  wrap.innerHTML = '';
  const count = (taskElem._subtasks || []).length;
  if (count <= 0) return;
  const scale = count > 12 ? Math.max(0.55, 12 / count) : 1;
  wrap.style.transform = `scale(${scale})`;
  for (let i = 0; i < count; i++) {
    const d = document.createElement('div'); d.className = 'dash'; wrap.appendChild(d);
  }
}

/* Invoice badge */
function updateInvoiceBadge(taskElem){
  const isInv = (taskElem.dataset.category || '').toLowerCase() === 'invoice';
  let b = taskElem.querySelector('.invoice-badge');
  if (!isInv) { if (b) b.remove(); return; }
  const pct = Number(taskElem.dataset.invoicePercent || 0);
  if (!b) { b = document.createElement('div'); b.className = 'invoice-badge';
    taskElem.insertBefore(b, taskElem.querySelector('.subtask-dashes') || null);
  }
  b.textContent = `Invoice: ${pct}%`;
}

/* Prompt helpers */
function promptPercent(defaultVal){
  const raw = prompt('Invoice percent (e.g., 30 for 30%)', defaultVal ?? '');
  if (raw === null) return null;
  const n = Math.round(Number(raw));
  if (!Number.isFinite(n) || n < 0 || n > 100) { alert('Please enter a number 0‚Äì100.'); return null; }
  return n;
}

/* Task meta (owner + tiny date/duration) */
function updateTaskMetaDisplay(taskElem){
  let meta = taskElem.querySelector('.task-meta');
  if (!meta){ meta = document.createElement('div'); meta.className = 'task-meta';
    taskElem.insertBefore(meta, taskElem.querySelector('.subtask-dashes') || null);
  }
  const owner = taskElem.dataset.owner || '';
  const hint = bestTaskDateLabel(taskElem);
  const parts = [];
  if (owner) parts.push(`üë§ ${owner}`);
  if (hint) parts.push(`üìÖ ${hint}`);
  meta.textContent = parts.join(' ‚Ä¢ ');
}

/* Robot resolution for a task */
function getResolvedRobot(taskElem){
  const taskRob = normalizeRobot(taskElem.dataset.robot);
  if (taskRob) return taskRob;
  const project = taskElem.closest('.project');
  const projRob = normalizeRobot(project?.dataset.robot);
  return projRob || 'UR';
}
function updateTaskIcon(taskElem){
  const [icon, color] = categoryIcon(taskElem.dataset.category || 'Task', getResolvedRobot(taskElem));
  const iconSpan = taskElem.querySelector('span.icon');
  if (iconSpan){
    iconSpan.textContent = icon;
    iconSpan.className = `icon ${color}`;
  }
}

/* Unique id for projects (session only) */
let NEXT_PID = 1;
function ensureProjectPid(projectElem){
  if (!projectElem.dataset.pid) projectElem.dataset.pid = String(NEXT_PID++);
}

/* Add / Build Task */
function addTaskToTimeline(timelineElem, insertBefore=null){
  if (READ_ONLY) return;
  const name=prompt("Task Name:","New Task"); if(!name) return;
  const hoursRaw=prompt("Estimated Base Hours:","0"); const hours=Number.isFinite(Number(hoursRaw))?Number(hoursRaw):0;
  const catRaw=prompt("Category (Task, Invoice, External):","Task")||"Task"; const category=normalizeCategory(catRaw);

  const data = {name, baseHours:hours, category, subtasks:[], completed:false};

  const owner = prompt("Owner (optional):","") || '';
  const ddRaw = prompt("Date or Duration (e.g., 9/14, 2025-09-14, 10d, 2w, 1mo; blank to skip):","") || '';
  const parsed = parseDateOrDuration(ddRaw);
  if (owner) data.owner = owner;
  if (parsed.iso) data.date = parsed.iso;
  if (parsed.label) data.dateText = parsed.label;

  const proj = timelineElem.closest('.project');
  const projRobot = normalizeRobot(proj?.dataset.robot) || 'UR';
  data.robot = projRobot;

  if (category.toLowerCase() === 'invoice') {
    const pct = promptPercent(''); if (pct === null) return; data.invoicePercent = pct;
  }

  const div=buildTask(data);
  if(insertBefore&&insertBefore.parentNode===timelineElem) timelineElem.insertBefore(div,insertBefore); else timelineElem.appendChild(div);
  updateTaskIcon(div);
  updateSubtaskHours(div); applyCompletionStyle(div); updateCurrentIndicator(timelineElem); updateSubtaskDashes(div); updateInvoiceBadge(div);
  updateFinalInvoiceUI(timelineElem);
  markDirty();
  requestAnimationFrame(()=>{ timelineElem.scrollLeft = timelineElem.scrollWidth; });
}

function buildTask(data){
  const div=document.createElement('div'); div.className='timeline-item'; div.setAttribute('draggable',!READ_ONLY);
  div.innerHTML=`<span class="icon blue">‚ñ†</span><div class="task-name">${(data.name||'Task')}</div><div class="timeline-label">Hours: <b><span class="task-total">0</span></b></div>`;
  const base=Number.isFinite(Number(data.baseHours))?Number(data.baseHours):0;
  div.dataset.baseHours=base; div.dataset.category=normalizeCategory(data.category||'Task'); div.dataset.completed=data.completed?'true':'false';
  if (typeof data.invoicePercent !== 'undefined') div.dataset.invoicePercent = Number(data.invoicePercent);
  if (data.owner) div.dataset.owner = data.owner;
  if (data.date) div.dataset.date = data.date;
  if (data.dateText) div.dataset.dateText = data.dateText;
  if (data.robot) div.dataset.robot = normalizeRobot(data.robot);

  div._subtasks=Array.isArray(data.subtasks)?data.subtasks.map(s=>({
    name:(s&&s.name)?s.name:'Subtask',
    hours:Number.isFinite(Number(s&&s.hours))?Number(s.hours):0,
    done:!!(s&&s.done),
    owner:(s&&s.owner)||'',
    date:(s&&s.date)||'',
    dateText:(s&&s.dateText)||''
  })):[];
  div.addEventListener('click',()=>openSubtaskModal(div));
  if (!READ_ONLY) { addTaskContextMenu(div); enableDragAndDrop(div); }
  updateSubtaskHours(div); updateSubtaskDashes(div); updateInvoiceBadge(div); updateTaskMetaDisplay(div); return div;
}

function addProject({name,robot='UR',customer='',application='',salesOrder,poNumber,estDate,tasks}){
  const container=document.getElementById('project-container');
  const div=document.createElement('div'); div.className='project';
  const subText = formatSubheader({robot, customer, application, salesOrder, poNumber, estDate});
  div.innerHTML=`<div class="project-header">${name}<button class="edit-btn" onclick="editProject(event,this)">Edit</button></div>
    <div class="project-subheader">${subText}</div>
    <div class="timeline"></div><div class="total-hours">Total Hours: 0</div>`;
  ensureProjectPid(div);
  div.dataset.robot = normalizeRobot(robot) || 'UR';
  const timeline=div.querySelector('.timeline');

  timeline.addEventListener('dragover', (e)=>{
    if (READ_ONLY) return;
    if (!dragged) return;
    e.preventDefault();
    const t = timeline;
    if (!dropIndicator){ dropIndicator = document.createElement('div'); dropIndicator.className = 'drop-indicator'; }
    if (!dropIndicator.parentNode || dropIndicator.parentNode !== t) t.appendChild(dropIndicator);

    const items = [...t.querySelectorAll('.timeline-item')].filter(x=>x!==dragged);
    let inserted = false;
    for (const it of items){
      const rect = it.getBoundingClientRect();
      const midpoint = rect.left + rect.width/2;
      if (e.clientX < midpoint){
        t.insertBefore(dropIndicator, it);
        inserted = true;
        break;
      }
    }
    if (!inserted) t.appendChild(dropIndicator);
  });
  timeline.addEventListener('drop', (e)=>{
    if (READ_ONLY) return;
    e.preventDefault();
    const t = timeline;
    if (dragged && (dragged.parentNode !== t || dropIndicator)){
      const ref = (dropIndicator && dropIndicator.parentNode===t) ? dropIndicator : null;
      if (ref) t.insertBefore(dragged, ref);
      else t.appendChild(dragged);
      updateTotalHours(t); updateCurrentIndicator(t); updateFinalInvoiceUI(t);
      markDirty();
    }
    if (dropIndicator && dropIndicator.parentNode===t) t.removeChild(dropIndicator);
    if (dragged) dragged.classList.remove('dragging');
    dragged = null;
    dragOriginTimeline = null;
  });
  timeline.addEventListener('dragleave', (e)=>{
    if (dropIndicator && !timeline.contains(e.relatedTarget)) {
      if (dropIndicator.parentNode===timeline) timeline.removeChild(dropIndicator);
    }
  });

  timeline.addEventListener('contextmenu',e=>{
    if (READ_ONLY) { e.preventDefault(); return; }
    e.preventDefault();
    if (e.target.closest('.timeline-item')) return;
    addTaskToTimeline(timeline);
  });
  timeline.addEventListener('dblclick',()=>{ if(!READ_ONLY) addTaskToTimeline(timeline); });

  container.appendChild(div);
  (tasks||[]).forEach(t=>{ const el = buildTask(t); timeline.appendChild(el); updateTaskIcon(el); });
  [...timeline.querySelectorAll('.timeline-item')].forEach(el=>{ applyCompletionStyle(el); updateSubtaskHours(el); updateSubtaskDashes(el); updateInvoiceBadge(el); updateTaskMetaDisplay(el); });
  updateTotalHours(timeline); updateCurrentIndicator(timeline);
  updateFinalInvoiceUI(timeline);
  return div;
}

/* Subtasks modal */
const modalBackdrop=document.getElementById('subtask-modal-backdrop');
const modalClose=document.getElementById('subtask-modal-close');
const modalDone=document.getElementById('subtask-modal-done');
const modalTitle=document.getElementById('subtask-modal-title');
const subtaskRows=document.getElementById('subtask-rows');
const addSubtaskBtn=document.getElementById('add-subtask-btn');
const addSubtaskWrap=document.getElementById('add-subtask-wrap');
const modalSummary=document.getElementById('modal-summary');
const readyInvoiceBtn=document.getElementById('ready-invoice-btn');
const riskBtn = document.getElementById('risk-btn');
let currentTask=null;

function openSubtaskModal(taskElem){
  currentTask=taskElem;
  const taskName=taskElem.querySelector('.task-name')?.textContent||'Task';
  modalTitle.textContent=`Subtasks ‚Äì ${taskName}`;
  renderSubtaskRows();

  const isInv = (taskElem.dataset.category||'').toLowerCase()==='invoice';
  readyInvoiceBtn.style.display = (!READ_ONLY && isInv) ? 'inline-block' : 'none';
  readyInvoiceBtn.onclick = (!READ_ONLY && isInv) ? (()=>openInvoiceModal(taskElem)) : null;

  const isRisk = /^risk\s*assessment$/i.test(taskName.trim());
  riskBtn.style.display = (!READ_ONLY && isRisk) ? 'inline-block' : 'none';
  riskBtn.onclick = (!READ_ONLY && isRisk) ? (()=>downloadRiskFromGithub(taskElem)) : null;

  addSubtaskWrap.style.display = READ_ONLY ? 'none' : 'block';
  modalDone.textContent = READ_ONLY ? 'Close' : 'Done';

  modalBackdrop.style.display='flex';
}
function closeSubtaskModal(){ modalBackdrop.style.display='none'; currentTask=null; }
modalClose.addEventListener('click',closeSubtaskModal); modalDone.addEventListener('click',closeSubtaskModal);
modalBackdrop.addEventListener('click',e=>{ if(e.target===modalBackdrop) closeSubtaskModal(); });

addSubtaskBtn.addEventListener('click',()=>{ if(!currentTask || READ_ONLY) return; const name=prompt("Subtask Name:","Subtask"); if(!name) return;
  const hoursRaw=prompt("Starting Hours:","0"); const hours=Number.isFinite(Number(hoursRaw))?Number(hoursRaw):0;
  currentTask._subtasks.push({name, hours, done:false, owner:'', date:'', dateText:''}); renderSubtaskRows(); markDirty(); });

/* Right-click context menu for SUBTASKS */
function addSubtaskContextMenu(wrap, st, idx, taskElem){
  if (READ_ONLY) return;
  wrap.addEventListener('contextmenu', (e)=>{
    e.preventDefault();
    contextMenu.innerHTML='';
    addContextItem('Add Hours‚Ä¶', ()=>{
      const addRaw=prompt(`Add hours to "${st.name}":`,"0");
      const add=Number.isFinite(Number(addRaw))?Number(addRaw):0;
      if(add>0){ st.hours=(Number(st.hours)||0)+add; renderSubtaskRows(); markDirty(); }
    });
    addContextItem(st.done ? 'Mark Incomplete' : 'Mark Complete', ()=>{
      st.done = !st.done; renderSubtaskRows(); markDirty();
    });
    addContextItem('Rename‚Ä¶', ()=>{
      const nn=prompt('New subtask name:',st.name);
      if(nn&&nn.trim()){ st.name=nn.trim(); renderSubtaskRows(); markDirty(); }
    });
    addContextItem('Set Owner‚Ä¶', ()=>{
      const v=prompt('Owner (optional):', st.owner||'');
      st.owner = (v||''); renderSubtaskRows(); markDirty();
    });
    addContextItem('Set Date/Duration‚Ä¶', ()=> openDateModalForSubtask(taskElem, idx));
    addContextItem('Delete Subtask', ()=>{
      taskElem._subtasks.splice(idx,1); renderSubtaskRows(); markDirty();
    });
    contextMenu.style.top=e.pageY+'px';
    contextMenu.style.left=e.pageX+'px';
    contextMenu.style.display='block';
  });
}

function renderSubtaskRows(){
  subtaskRows.innerHTML=''; if(!currentTask) return;
  const rows=currentTask._subtasks||[];

  const base = Number(currentTask.dataset.baseHours||0) || 0;
  const subsTotal = rows.reduce((s,r)=>s+(Number(r.hours)||0),0);
  const parentTotal = base + subsTotal;
  const maxForFallback = Math.max(1,...rows.map(r=>Number(r.hours)||0));

  rows.forEach((st,idx)=>{
    const wrap=document.createElement('div'); wrap.className='subtask-chip';
    wrap.title= READ_ONLY ? '' : 'Right-click for actions ‚Ä¢ Click bar to add hours';

    const barWrap=document.createElement('div'); barWrap.className='chip-bar-wrap';
    const bar=document.createElement('div'); bar.className='chip-bar';

    let pct = 0;
    if (parentTotal > 0) pct = Math.max(0, (Number(st.hours)||0) / parentTotal * 100);
    else pct = (Math.min(Number(st.hours)||0, maxForFallback)/maxForFallback)*100;
    bar.style.width = `${pct}%`;

    const extraBits = [];
    const stDate = subtaskLabel(st);
    if (stDate) extraBits.push(stDate);
    if (st.owner) extraBits.push(`üë§ ${st.owner}`);
    const extraText = extraBits.length ? ' ‚Äî ' + extraBits.join(' ‚Ä¢ ') : '';

    const label=document.createElement('div'); label.className='chip-label';
    label.textContent=`${st.name} ‚Äî ${st.hours}h${st.done?" (Complete)":""}${extraText}`;

    barWrap.appendChild(bar); barWrap.appendChild(label);

    if (!READ_ONLY) {
      barWrap.onclick=()=>{
        const addRaw=prompt(`Add hours to "${st.name}":`,"0");
        const add=Number.isFinite(Number(addRaw))?Number(addRaw):0;
        if(add>0){ st.hours=(Number(st.hours)||0)+add; renderSubtaskRows(); markDirty(); }
      };
      addSubtaskContextMenu(wrap, st, idx, currentTask);
    }
    wrap.appendChild(barWrap);
    subtaskRows.appendChild(wrap);
  });

  updateSubtaskHours(currentTask);
  updateModalSummary();
  updateCurrentIndicator(currentTask.closest('.timeline'));
  applyCompletionStyle(currentTask);
  updateSubtaskDashes(currentTask);
}

/* Totals & completion */
function updateModalSummary(){ if(!currentTask) return; const base=Number(currentTask.dataset.baseHours||0);
  const subs=(currentTask._subtasks||[]).reduce((s,x)=>s+(Number(x.hours)||0),0); const total=base+subs;
  modalSummary.innerHTML=`<span><b>Base:</b> ${base}</span><span><b>Subtasks:</b> ${subs}</span><span><b>Total:</b> ${total}</span>`; }

function isTaskComplete(taskElem){ const subs=taskElem._subtasks||[]; if(subs.length>0) return subs.every(st=>!!st.done); return taskElem.dataset.completed==='true'; }
function setTaskComplete(taskElem,val){ if (READ_ONLY) return; taskElem.dataset.completed=val?'true':'false'; applyCompletionStyle(taskElem); updateCurrentIndicator(taskElem.closest('.timeline')); markDirty(); }
function applyCompletionStyle(taskElem){ if(isTaskComplete(taskElem)) taskElem.classList.add('completed'); else taskElem.classList.remove('completed'); }

function updateSubtaskHours(taskElem){
  const subHours=(taskElem._subtasks||[]).reduce((sum,st)=>sum+(Number(st.hours)||0),0);
  const baseHours=Number(taskElem.dataset.baseHours||0); const total=baseHours+subHours;
  const totalLabel=taskElem.querySelector('.task-total'); if(totalLabel) totalLabel.textContent=total; taskElem.dataset.totalHours=total;
  const tl=taskElem.closest('.timeline'); updateTotalHours(tl); applyCompletionStyle(taskElem); updateTaskMetaDisplay(taskElem);
}

function updateTotalHours(timelineElem){
  if(!timelineElem) return;
  const total=[...timelineElem.querySelectorAll('.timeline-item')].reduce((sum,el)=>sum+Number(el.dataset.totalHours||el.dataset.baseHours||0),0);
  const totalHoursElem=timelineElem.closest('.project')?.querySelector('.total-hours');
  if (totalHoursElem) totalHoursElem.textContent=`Total Hours: ${total}`;
  updateFinalInvoiceUI(timelineElem);
}

function updateCurrentIndicator(timelineElem){ if(!timelineElem) return; const tasks=[...timelineElem.querySelectorAll('.timeline-item')];
  tasks.forEach(t=>{ t.querySelector('.current-tag')?.remove(); t.querySelector('.current-text')?.remove(); applyCompletionStyle(t); });
  const firstIncomplete=tasks.find(t=>!isTaskComplete(t)); if(!firstIncomplete) return; const tag=document.createElement('div'); tag.className='current-tag';
  const text=document.createElement('div'); text.className='current-text'; text.textContent='CURRENT'; firstIncomplete.appendChild(tag); firstIncomplete.appendChild(text); }

/* Identify last Invoice card */
function updateFinalInvoiceUI(timelineElem){
  if (!timelineElem) return;
  const invs = [...timelineElem.querySelectorAll('.timeline-item')].filter(el => (el.dataset.category||'').toLowerCase()==='invoice');
  invs.forEach(el => { el.dataset.isFinalInvoice = 'false'; el.classList.remove('final-invoice'); });
  if (invs.length === 0) return;
  const last = invs[invs.length - 1];
  last.dataset.isFinalInvoice = 'true';
  last.classList.add('final-invoice');
}

/* Right-click menu for TASK cards */
function addTaskContextMenu(taskElem){
  taskElem.addEventListener('contextmenu',function(e){
    if (READ_ONLY) { e.preventDefault(); return; }
    e.preventDefault();
    contextMenu.innerHTML='';

    addContextItem('Edit Task',()=>{ const nameEl=taskElem.querySelector('.task-name');
      const newName=prompt('Edit Task Name:',nameEl.textContent);
      const newHoursRaw=prompt('Edit Base Hours:',taskElem.dataset.baseHours||'0'); const newHours=Number.isFinite(Number(newHoursRaw))?Number(newHoursRaw):0;
      let newCategory=normalizeCategory(prompt('Edit Category (Task, Invoice, External):',taskElem.dataset.category||'Task')||'Task');

      const newOwner = prompt('Owner (optional):', taskElem.dataset.owner || '') || '';

      if(newName) nameEl.textContent=newName;
      taskElem.dataset.baseHours=newHours; taskElem.dataset.category=newCategory;
      taskElem.dataset.owner = newOwner;

      if (newCategory.toLowerCase() === 'invoice' && typeof taskElem.dataset.invoicePercent === 'undefined') {
        const pct = promptPercent(''); if (pct !== null) taskElem.dataset.invoicePercent = pct;
      }
      if (newCategory.toLowerCase() !== 'invoice') { delete taskElem.dataset.invoicePercent; }

      updateTaskIcon(taskElem);
      updateSubtaskHours(taskElem); updateCurrentIndicator(taskElem.closest('.timeline'));
      updateInvoiceBadge(taskElem); updateSubtaskDashes(taskElem); updateTaskMetaDisplay(taskElem); updateFinalInvoiceUI(taskElem.closest('.timeline'));
      markDirty();
    });

    addContextItem('Set Date/Duration‚Ä¶', ()=> openDateModalForTask(taskElem));

    const resolved = getResolvedRobot(taskElem);
    if (resolved === 'Fanuc') {
      addContextItem('Change Robot to UR', ()=>{
        taskElem.dataset.robot = 'UR';
        updateTaskIcon(taskElem);
        markDirty();
      });
    } else {
      addContextItem('Change Robot to Fanuc', ()=>{
        taskElem.dataset.robot = 'Fanuc';
        updateTaskIcon(taskElem);
        markDirty();
      });
    }

    if ((taskElem.dataset.category||'').toLowerCase() === 'invoice') {
      addContextItem('Edit Invoice %', ()=>{
        const cur = taskElem.dataset.invoicePercent || '';
        const pct = promptPercent(cur);
        if (pct === null) return;
        taskElem.dataset.invoicePercent = pct;
        updateInvoiceBadge(taskElem); updateFinalInvoiceUI(taskElem.closest('.timeline')); markDirty();
      });
    }

    addContextItem(isTaskComplete(taskElem)?'Mark Task Incomplete':'Mark Task Complete',()=>{ if((taskElem._subtasks||[]).length===0) setTaskComplete(taskElem,!isTaskComplete(taskElem)); else alert('Task completion is controlled by its subtasks.'); });
    addContextItem('Delete Task',()=>{ const parent=taskElem.closest('.timeline'); taskElem.remove(); updateTotalHours(parent); updateCurrentIndicator(parent); updateFinalInvoiceUI(parent); markDirty(); });
    addContextItem('Add Task Before',()=>{ addTaskToTimeline(taskElem.parentElement,taskElem); });
    addContextItem('Add Subtask',()=>{ openSubtaskModal(taskElem); });
    contextMenu.style.top=e.pageY+'px'; contextMenu.style.left=e.pageX+'px'; contextMenu.style.display='block';
  });
}
function addContextItem(label,action){ const div=document.createElement('div'); div.textContent=label;
  div.addEventListener('mousedown',(e)=>{ e.preventDefault(); e.stopPropagation(); contextMenu.style.display='none'; setTimeout(action,0); });
  contextMenu.appendChild(div); }
function enableDragAndDrop(elem){ if (READ_ONLY) return;
  elem.addEventListener('dragstart',e=>{ dragged=elem; dragOriginTimeline = elem.closest('.timeline'); e.dataTransfer.setData('text/plain',''); elem.classList.add('dragging'); });
  elem.addEventListener('dragend',e=>{ if (dropIndicator && dropIndicator.parentNode) dropIndicator.parentNode.removeChild(dropIndicator); elem.classList.remove('dragging'); dragged=null; dragOriginTimeline=null; });
  elem.addEventListener('dragover',e=>e.preventDefault());
  elem.addEventListener('drop',e=>{ e.preventDefault(); });
}

/* New project + default template (now reads Settings.data.defaultTimeline if present) */
document.getElementById('new-project-btn').addEventListener('click',()=>{
  if (READ_ONLY) return;
  const projectName=prompt("Project Name:"); if(!projectName) return;
  const robot=normalizeRobot(prompt("Robot (UR/Fanuc):","UR")) || 'UR';
  const customer=prompt("Customer:") || '';
  const application=prompt("Application:") || '';
  const salesOrder=prompt("Sales Order:") || '';
  const poNumber=prompt("PO Number:") || '';
  const estDate=prompt("Estimated Completion Date:") || '';
  const project = addProject({ name:projectName, robot, customer, application, salesOrder, poNumber, estDate, tasks:[] });
  markDirty();

  const addTemplate = confirm("Add default timeline template to this project?");
  if (addTemplate) {
    const template = (Settings.data.defaultTimeline && Settings.data.defaultTimeline.length)
      ? Settings.data.defaultTimeline
      : DEFAULT_TIMELINE;

    const timeline = project.querySelector('.timeline');
    template.forEach(t => {
      const card = buildTask({
        name: t.name,
        baseHours: 0,
        category: t.category,
        subtasks: [],
        completed: false,
        invoicePercent: (typeof t.invoicePercent !== 'undefined') ? t.invoicePercent : undefined,
        robot
      });
      timeline.appendChild(card);
      updateTaskIcon(card);
    });
    [...timeline.querySelectorAll('.timeline-item')].forEach(el=>{ updateSubtaskHours(el); updateSubtaskDashes(el); updateInvoiceBadge(el); updateTaskMetaDisplay(el); });
    updateTotalHours(timeline); updateCurrentIndicator(timeline);
    updateFinalInvoiceUI(timeline);
    markDirty();
  }
});

function refreshProjectTaskIcons(projectElem){
  const tasks = [...projectElem.querySelectorAll('.timeline-item')];
  tasks.forEach(updateTaskIcon);
}

function editProject(ev, btn){
  if (READ_ONLY) return;
  if (ev) { ev.preventDefault(); ev.stopPropagation(); }
  const project=btn.closest('.project');
  ensureProjectPid(project);
  const header=project.querySelector('.project-header');
  const subheader=project.querySelector('.project-subheader');

  const rect = btn.getBoundingClientRect();
  contextMenu.innerHTML='';
  addContextItem('Edit Project Details', ()=>{
    const currentTitle=header.childNodes[0].textContent.trim();
    const parsed = parseSubheaderText(subheader.textContent);
    const projectName=prompt("Edit Project Name:",currentTitle) ?? currentTitle;
    const robot=normalizeRobot(prompt("Edit Robot (UR/Fanuc):", parsed.robot || project.dataset.robot || 'UR')) || 'UR';
    const customer=prompt("Edit Customer:", parsed.customer) ?? parsed.customer;
    const application=prompt("Edit Application:", parsed.application) ?? parsed.application;
    const salesOrder=prompt("Edit Sales Order:", parsed.salesOrder) ?? parsed.salesOrder;
    const poNumber=prompt("Edit PO Number:", parsed.poNumber) ?? parsed.poNumber;
    const estDate=prompt("Edit Estimated Completion Date:", parsed.estDate) ?? parsed.estDate;

    header.childNodes[0].textContent=projectName;
    subheader.textContent = formatSubheader({robot, customer, application, salesOrder, poNumber, estDate});
    project.dataset.robot = robot;
    refreshProjectTaskIcons(project);
    updateFinalInvoiceUI(project.querySelector('.timeline'));
    markDirty();
  });
  addContextItem('Delete Project', ()=>{
    if (confirm('Delete this project and all its tasks? This cannot be undone.')) {
      project.remove();
      markDirty();
    }
  });
  contextMenu.style.top = (window.scrollY + rect.bottom + 4) + 'px';
  contextMenu.style.left = (window.scrollX + rect.left) + 'px';
  contextMenu.style.display='block';
}

/* INVOICE EMAIL GENERATOR (unchanged) */
const invBackdrop = document.getElementById('invoice-modal-backdrop');
const invClose = document.getElementById('invoice-modal-close');
const invSubject = document.getElementById('invoice-subject');
const invBody = document.getElementById('invoice-body');
const invCopy = document.getElementById('invoice-copy');
const invOpen = document.getElementById('invoice-open-mail');
const invComplete = document.getElementById('invoice-complete');
let invoiceTaskRef = null;

function isFinalInvoiceTask(taskElem){
  if (!taskElem) return false;
  const tl = taskElem.closest('.timeline');
  const invs = [...tl.querySelectorAll('.timeline-item')].filter(el => (el.dataset.category||'').toLowerCase()==='invoice');
  return invs.length && invs[invs.length-1] === taskElem;
}
function getProjectDetails(taskElem){
  const tl = taskElem.closest('.timeline');
  const total = [...tl.querySelectorAll('.timeline-item')].reduce((s,el)=> s + Number(el.dataset.totalHours||el.dataset.baseHours||0), 0);
  const project = tl.closest('.project');
  const projName = project.querySelector('.project-header').childNodes[0].textContent.trim();
  const parsed = parseSubheaderText(project.querySelector('.project-subheader').textContent);
  return { total, projName, ...parsed, robot: project.dataset.robot || parsed.robot || '' };
}
function openInvoiceModal(taskElem){
  if (READ_ONLY) return;
  invoiceTaskRef = taskElem;

  const { total, projName, customer, application, poNumber:po, salesOrder:so } = getProjectDetails(taskElem);
  const stepName = taskElem.querySelector('.task-name').textContent.trim();
  const pct = taskElem.dataset.invoicePercent ? `${taskElem.dataset.invoicePercent}%` : '';

  const isFinal = isFinalInvoiceTask(taskElem);

  if (isFinal) {
    const name = Settings.data.finalName || 'Zach';
    invSubject.value = `Final Invoice: ${projName} ‚Äî ${stepName}${pct?` (${pct})`:''}`;
    invBody.value =
`Hey ${name},

${projName} Project has been completed, and we are ready to process through the BOM and close out this project. Remaining balance can be invoiced to the customer as well when you are done. Total project hours are listed below. Hollar with any questions.

Project Details:
Customer: ${customer}
Application: ${application}
Project: ${projName}
PO: ${po}
Sales Order: ${so}
Phase: ${stepName}
Project Hours: ${total}

Thanks!`;
  } else {
    const name = Settings.data.primaryName || 'Katie';
    invSubject.value = `Ready to Invoice: ${projName} ‚Äî ${stepName}${pct?` (${pct})`:''}`;
    invBody.value =
`Hello ${name},

Can you please generate an invoice for the following project/phase.

Project Details:
Customer: ${customer}
Application: ${application}
Project: ${projName}
PO: ${po}
Sales Order: ${so}
Phase: ${stepName}
Amount: ${pct || '(specify %)'}

Notes:
- Please let me know when it gets sent out, so I can mark it complete in my notes.

Thank you!`;
  }

  invBackdrop.style.display = 'flex';
}
function closeInvoiceModal(){ invBackdrop.style.display = 'none'; invoiceTaskRef = null; }
invClose.addEventListener('click', closeInvoiceModal);
invBackdrop.addEventListener('click', e=>{ if(e.target===invBackdrop) closeInvoiceModal(); });
invCopy.addEventListener('click', ()=>{ navigator.clipboard.writeText(invBody.value).then(()=>alert('Copied.')); });
invOpen.addEventListener('click', ()=>{
  if (!invoiceTaskRef) return;
  const isFinal = isFinalInvoiceTask(invoiceTaskRef);
  const subj = encodeURIComponent(invSubject.value);
  const body = encodeURIComponent(invBody.value);

  if (isFinal) {
    const to = Settings.data.finalEmail || 'zschuchardt@gogcg.com';
    window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subj}&body=${body}`;
  } else {
    const to = Settings.data.primaryEmail || '';
    if (!to) { alert("Please set the Primary Invoice Email in Settings."); return; }
    const cc = Settings.data.finalEmail || 'zschuchardt@gogcg.com';
    window.location.href = `mailto:${encodeURIComponent(to)}?cc=${encodeURIComponent(cc)}&subject=${subj}&body=${body}`;
  }
});
invComplete.addEventListener('click', ()=>{
  if (!invoiceTaskRef) return;
  (invoiceTaskRef._subtasks || []).forEach(st => st.done = true);
  invoiceTaskRef.dataset.completed = 'true';
  updateSubtaskHours(invoiceTaskRef);
  updateCurrentIndicator(invoiceTaskRef.closest('.timeline'));
  applyCompletionStyle(invoiceTaskRef);
  markDirty();
  closeInvoiceModal();
  alert('Marked invoice task as complete.');
});

/* ---------- GitHub XLSM downloader ---------- */
function toRawGithub(urlStr){
  try {
    const u = new URL(urlStr);
    if (!/^https?:$/i.test(u.protocol)) return null;
    const parts = u.pathname.split('/').filter(Boolean);
    if (u.hostname === 'raw.githubusercontent.com') return u.toString();
    if (u.hostname !== 'github.com' || parts.length < 4) return null;

    const owner = parts[0];
    const repo  = parts[1];
    const kind  = parts[2];
    let ref = '';
    let pathParts = [];

    if (kind === 'blob' || kind === 'raw' || kind === 'tree') {
      if (parts[3] === 'refs' && parts[4] === 'heads' && parts[5]) {
        ref = parts[5];
        pathParts = parts.slice(6);
      } else {
        ref = parts[3];
        pathParts = parts.slice(4);
      }
    } else if (kind === 'refs' && parts[3] === 'heads' && parts[4]) {
      ref = parts[4];
      pathParts = parts.slice(5);
    } else {
      return null;
    }

    const path = pathParts.join('/');
    return `https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${path}`;
  } catch (_){ return null; }
}
function buildRiskFileName(details){
  const pattern = (Settings.data.riskFileNamePattern || '').trim() || 'Risk Assessment [YYYY-MM-DD].xlsm';
  const now = new Date();
  const yyyy = String(now.getFullYear());
  const mm = pad2(now.getMonth()+1);
  const dd = pad2(now.getDate());

  const tokenMap = {
    'CUSTOMER': details.customer || '',
    'PROJECT': details.projName || '',
    'APPLICATION': details.application || '',
    'SALESORDER': details.salesOrder || '',
    'PO': details.poNumber || '',
    'ROBOT': normalizeRobot(details.robot || '') || '',
    'YYYY': yyyy, 'MM': mm, 'DD': dd,
    'YYYY-MM-DD': `${yyyy}-${mm}-${dd}`,
    'MM-DD-YYYY': `${mm}-${dd}-${yyyy}`,
    'MM DD YYYY': `${mm} ${dd} ${yyyy}`
  };

  const out = pattern.replace(/\[([^\]]+)\]/g, (_, keyRaw)=>{
    const k = String(keyRaw || '').trim().toUpperCase();
    return Object.prototype.hasOwnProperty.call(tokenMap, k) ? tokenMap[k] : `[${keyRaw}]`;
  });

  const ext = out.toLowerCase().endsWith('.xlsm') ? '' : '.xlsm';
  const safe = (out + ext).replace(/[\\\/\?\*\|"<>\:]+/g, '-').replace(/\s{2,}/g,' ').trim();
  return safe || `Risk Assessment ${yyyy}-${mm}-${dd}.xlsm`;
}
async function downloadRiskFromGithub(taskElem){
  try{
    const urlInput = (Settings.data.riskGithubUrl || '').trim();
    if (!urlInput) { alert('Please set the GitHub XLSM URL in Settings.'); return; }
    const rawUrl = toRawGithub(urlInput);
    if (!rawUrl) { alert('The GitHub URL does not look valid. Paste a public blob/raw link.'); return; }

    const details = getProjectDetails(taskElem);
    const filename = buildRiskFileName(details);

    showLoading(true);
    const res = await fetch(rawUrl, { mode:'cors', cache:'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const blob = await res.blob();
    const finalBlob = blob.type ? blob : new Blob([blob], { type: 'application/vnd.ms-excel.sheet.macroEnabled.12' });

    const a = document.createElement('a');
    const href = URL.createObjectURL(finalBlob);
    a.href = href;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(href); a.remove(); }, 0);
  } catch (e){
    alert('Download failed: ' + e.message + '\n\nTips:\n‚Ä¢ Repo must be public\n‚Ä¢ Use a blob/raw URL and Save Settings\n‚Ä¢ We auto-convert to raw.githubusercontent.com');
  } finally {
    showLoading(false);
  }
}

/* Google Save/Load */
function serializeState(){
  const projects=[...document.querySelectorAll('.project')].map(project=>{
    ensureProjectPid(project);
    const title=project.querySelector('.project-header').childNodes[0].textContent.trim();
    const parsed = parseSubheaderText(project.querySelector('.project-subheader').textContent);
    const robot = normalizeRobot(project.dataset.robot) || normalizeRobot(parsed.robot) || 'UR';
    const timeline=project.querySelector('.timeline');
    const tasks=[...timeline.querySelectorAll('.timeline-item')].map((t,idx)=>({
      name:t.querySelector('.task-name').textContent,
      baseHours:Number(t.dataset.baseHours||0),
      category:t.dataset.category||'Task',
      completed:isTaskComplete(t),
      order:idx,
      invoicePercent: (typeof t.dataset.invoicePercent !== 'undefined') ? Number(t.dataset.invoicePercent) : undefined,
      owner: t.dataset.owner || '',
      date: t.dataset.date || '',
      dateText: t.dataset.dateText || '',
      isDeadline: t.dataset.isDeadline === 'true',
      robot: t.dataset.robot || '',
      subtasks:(t._subtasks||[]).map(st=>({
        name:st.name, hours:Number(st.hours||0), done:!!st.done,
        owner: st.owner || '',
        date: st.date || '',
        dateText: st.dateText || ''
      }))
    }));
    return {
      name:title,
      robot,
      customer: parsed.customer,
      application: parsed.application,
      poNumber: parsed.poNumber,
      estDate: parsed.estDate,
      salesOrder: parsed.salesOrder,
      tasks
    };
  });
  return {
    projects,
    settings: { ...Settings.data },
    kind:'ProjectTracker',
    allowEmpty:(projects.length===0)
  };
}
function clearAllProjects(){ document.getElementById('project-container').innerHTML=''; }
function loadState(state){
  if(!state) return;
  if (state.settings) {
    Settings.data = { ...Settings.data, ...state.settings };
  }
  if(!state.projects) return;
  clearAllProjects();
  state.projects.forEach(p=>{
    const proj = addProject({
      name:p.name,
      robot: p.robot || 'UR',
      customer:p.customer||'',
      application:p.application||'',
      salesOrder:p.salesOrder||'',
      poNumber:p.poNumber||'',
      estDate:p.estDate||'',
      tasks:(p.tasks||[]).map(t=>({
        name:t.name,
        baseHours:t.baseHours,
        category:t.category,
        completed:!!t.completed,
        invoicePercent: (typeof t.invoicePercent!=='undefined')?t.invoicePercent:undefined,
        owner: t.owner || '',
        date: t.date || '',
        dateText: t.dateText || '',
        isDeadline: !!(t.isDeadline || t.deadline),
        robot: t.robot || '',
        subtasks:(t.subtasks||[]).map(st=>({
          name:st.name, hours:st.hours, done:!!st.done,
          owner: st.owner || '',
          date: st.date || '',
          dateText: st.dateText || ''
        }))
      }))
    });
    ensureProjectPid(proj);
  });
}

async function saveToGoogle({silent=false} = ''){
  if (READ_ONLY) return;
  const payload=serializeState();
  try{
    const res=await fetch(GOOGLE_URL,{ method:'POST', mode:'cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
    const text=await res.text();
    let data=null; try{ data=JSON.parse(text); }catch{}
    if(!silent){
      if(data && data.ok){ alert(`‚úÖ Saved ${data.saved} project(s) to Google.`); hasLocalEdits = false; }
      else if (data && data.blocked) { alert('‚ö†Ô∏è Save blocked: empty payload not allowed. Add a project before saving.'); }
      else if (data && data.ignored) { alert('‚ö†Ô∏è Save response not recognized.'); }
      else { alert('‚ö†Ô∏è Save response not recognized.'); }
    }
  } catch(e){
    if(!silent) alert('‚ùå Save failed: ' + e.message);
  }
}

async function loadFromGoogle({forceApply=true} = {}){
  try{
    const res=await fetch(GOOGLE_URL,{ mode:'cors' });
    const text=await res.text();
    const data=JSON.parse(text);
    if (forceApply) { loadState(data); if(!READ_ONLY) hasLocalEdits = false; }
  } catch(e){
    try{
      const cb='PT_JSONP_'+Date.now();
      window[cb]=(data)=>{ try{ if (forceApply){ loadState(data); if(!READ_ONLY) hasLocalEdits=false; } } finally{ delete window[cb]; } };
      const s=document.createElement('script'); s.src=GOOGLE_URL+'?callback='+cb; s.onerror=()=>{}; document.body.appendChild(s);
    }catch(err){ /* noop */ }
  }
}

/* Print helpers (unchanged) */
function collectStyleText() { return Array.from(document.querySelectorAll('style')).map(s => s.innerHTML).join('\n'); }
function exportPDFFit(size) {
  const page = (size === 'tabloid')
    ? { wIn: 17, hIn: 11, label: '17in 11in' }
    : { wIn: 11, hIn: 8.5, label: '11in 8.5in' };
  const marginIn = 0.5;
  const availWidthPx = (page.wIn - 2*marginIn) * 96;

  const w = window.open('', '_blank');
  if (!w) { alert('Popup blocked. Please allow popups for this site to export PDF.'); return; }
  const inPageStyles = collectStyleText();
  const contentHTML = document.getElementById('project-container').outerHTML;

  const htmlStart = `
<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Project Tracker ‚Äî Fit (${size})</title>
<style>
${inPageStyles}
@media print { @page { size: ${page.label}; margin: ${marginIn}in; } }
body { font-family: Arial, sans-serif; padding: ${marginIn}in; }
.timeline { overflow: visible !important; display: flex !important; flex-wrap: nowrap !important; gap: 6px !important; }
.timeline-item { box-shadow: none; border: 1px solid #ddd; }
.timeline.__fit { transform-origin: top left; }
.project { page-break-inside: avoid; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 0 0 12px 0; }
.project-header { font-size: 16px; }
.project-subheader { font-size: 11px; }
.task-name { font-size: 11px; }
.timeline-label { font-size: 9px; }
.invoice-badge { font-size: 9px; padding: 1px 5px; }
.subtask-dashes .dash { width:8px; height:2px; }
.total-hours { font-size: 11px; }
.topbar, #context-menu, .modal-backdrop, #new-project-btn { display:none !important; }
</style>
</head><body>
${contentHTML}
`;

  const js = `
(function(){
  var timelines = Array.from(document.querySelectorAll('.timeline'));
  var maxW = 0;
  timelines.forEach(function(t){
    t.classList.add('__fit');
    var w = t.scrollWidth;
    if (w > maxW) maxW = w;
  });
  var avail = ${Math.floor(availWidthPx)};
  var scale = maxW > 0 ? Math.min(1, avail / maxW) : 1;
  timelines.forEach(function(t){
    var h = t.getBoundingClientRect().height;
    var scaledH = h * scale;
    t.style.transform = 'scale(' + scale + ')';
    t.style.height = scaledH + 'px';
  });
  setTimeout(function(){ window.print(); }, 300);
})();
`;

  const htmlEnd = `</body></html>`;

  w.document.open();
  w.document.write(htmlStart);
  w.document.write('<scr' + 'ipt>' + js + '</scr' + 'ipt>');
  w.document.write(htmlEnd);
  w.document.close();
  w.focus();
}

/* Date/Duration editor modal logic (unchanged) */
const dateBackdrop = document.getElementById('date-modal-backdrop');
const dateClose = document.getElementById('date-modal-close');
const dateCancel = document.getElementById('date-cancel');
const dateSave = document.getElementById('date-save');
const dateClear = document.getElementById('date-clear');
const dateInput = document.getElementById('date-input');
const durInput = document.getElementById('dur-input');

let dateCtx = null;

function openDateModalForTask(taskElem){
  if (READ_ONLY) return;
  dateCtx = { type:'task', taskElem };
  dateInput.value = taskElem.dataset.date || '';
  durInput.value = taskElem.dataset.dateText || '';
  dateBackdrop.style.display = 'flex';
}
function openDateModalForSubtask(taskElem, index){
  if (READ_ONLY) return;
  dateCtx = { type:'sub', taskElem, subIndex:index };
  const st = taskElem._subtasks[index];
  dateInput.value = st.date || '';
  durInput.value = st.dateText || '';
  dateBackdrop.style.display = 'flex';
}
function closeDateModal(){ dateBackdrop.style.display = 'none'; dateCtx = null; }
dateClose.addEventListener('click', closeDateModal);
dateCancel.addEventListener('click', closeDateModal);
dateBackdrop.addEventListener('click', e=>{ if(e.target===dateBackdrop) closeDateModal(); });

dateClear.addEventListener('click', ()=>{
  if (!dateCtx) return;
  if (dateCtx.type==='task'){
    delete dateCtx.taskElem.dataset.date;
    delete dateCtx.taskElem.dataset.dateText;
    updateTaskMetaDisplay(dateCtx.taskElem);
    markDirty();
  } else {
    const st = dateCtx.taskElem._subtasks[dateCtx.subIndex];
    st.date=''; st.dateText='';
    renderSubtaskRows();
    markDirty();
  }
  closeDateModal();
});

dateSave.addEventListener('click', ()=>{
  if (!dateCtx) return;
  const dateVal = (dateInput.value || '').trim();
  const durVal = (durInput.value || '').trim();
  let iso = '', label = '';
  if (dateVal){
    iso = dateVal;
  } else if (durVal){
    const p = parseDateOrDuration(durVal);
    if (!p.iso && !p.label){ alert('Please enter a valid date or duration.'); return; }
    if (p.iso) iso = p.iso; else label = p.label;
  } else {
    iso = ''; label = '';
  }

  if (dateCtx.type==='task'){
    if (iso) dateCtx.taskElem.dataset.date = iso; else delete dateCtx.taskElem.dataset.date;
    if (label) dateCtx.taskElem.dataset.dateText = label; else delete dateCtx.taskElem.dataset.dateText;
    updateTaskMetaDisplay(dateCtx.taskElem);
  } else {
    const st = dateCtx.taskElem._subtasks[dateCtx.subIndex];
    st.date = iso || '';
    st.dateText = label || (iso ? '' : '');
    renderSubtaskRows();
  }
  markDirty();
  closeDateModal();
});

/* Buttons */
const saveBtn = document.getElementById('saveGoogleBtn');
const loadBtn = document.getElementById('loadGoogleBtn');
const newProjectBtn = document.getElementById('new-project-btn');
const printBtn = document.getElementById('printBtn');
const printTabloidBtn = document.getElementById('printTabloidBtn');
const settingsBtn = document.getElementById('settingsBtn');
const assignmentsBtn = document.getElementById('assignmentsBtn');

/* Attach listeners */
if (saveBtn) saveBtn.addEventListener('click', ()=> saveToGoogle({silent:false}));
if (loadBtn) loadBtn.addEventListener('click', async ()=>{
  if (!READ_ONLY && hasLocalEdits && !confirm('This will overwrite your current unsaved changes with the latest from Google. Continue?')) return;
  showLoading(true);
  try { await loadFromGoogle({forceApply:true}); } finally { showLoading(false); }
});
if (printBtn) printBtn.addEventListener('click', ()=> exportPDFFit('letter'));
if (printTabloidBtn) printTabloidBtn.addEventListener('click', ()=> exportPDFFit('tabloid'));

/* Settings modal handlers */
const settingsBackdrop = document.getElementById('settings-backdrop');
const settingsClose = document.getElementById('settings-close');
const settingsSave = document.getElementById('settings-save');

/* Tabs */
const settingsTabs = document.getElementById('settings-tabs');
const tabButtons = () => [...document.querySelectorAll('#settings-tabs .tab-btn')];
const tabPanes = () => [...document.querySelectorAll('.tab-pane')];
function activateTab(id){
  tabButtons().forEach(b=> b.classList.toggle('active', b.dataset.tab === id));
  tabPanes().forEach(p=> p.classList.toggle('active', p.id === id));
}
function initTabs(){
  settingsTabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    activateTab(btn.dataset.tab);
  });
}

/* Invoice Contact fields */
const setPrimaryName = document.getElementById('set-primary-name');
const setPrimaryEmail = document.getElementById('set-primary-email');
const setFinalName = document.getElementById('set-final-name');
const setFinalEmail = document.getElementById('set-final-email');

/* Project Order list */
const projOrderList = document.getElementById('proj-order-list');

function buildProjectOrderList(){
  projOrderList.innerHTML = '';
  const projects = [...document.querySelectorAll('#project-container .project')];
  if (projects.length === 0){
    projOrderList.innerHTML = '<div style="font-size:12px; color:#777;">No active projects.</div>';
    return;
  }
  projects.forEach(p=>{
    ensureProjectPid(p);
    const item = document.createElement('div');
    item.className = 're-item';
    item.draggable = true;
    item.dataset.pid = p.dataset.pid;
    item.innerHTML = `<span class="re-handle">‚ò∞</span><span class="re-name"></span>`;
    item.querySelector('.re-name').textContent = p.querySelector('.project-header').childNodes[0].textContent.trim();
    attachReorderDnD(item);
    projOrderList.appendChild(item);
  });
}
let dragReItem = null;
function attachReorderDnD(item){
  item.addEventListener('dragstart', ()=>{
    dragReItem = item;
    item.classList.add('re-ghost');
  });
  item.addEventListener('dragend', ()=>{
    item.classList.remove('re-ghost');
    dragReItem = null;
  });
  item.addEventListener('dragover', (e)=>{
    e.preventDefault();
    if (!dragReItem || dragReItem === item) return;
    const list = projOrderList;
    const rect = item.getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    if (e.clientY < mid) {
      list.insertBefore(dragReItem, item);
    } else {
      list.insertBefore(dragReItem, item.nextSibling);
    }
  });
}

/* Risk fields */
const setRiskGithub = document.getElementById('set-risk-github');
const setRiskPattern = document.getElementById('set-risk-pattern');

/* -------- Default Timeline Editor -------- */
const dtlList = document.getElementById('dtl-list');
const dtlAdd = document.getElementById('dtl-add');
const dtlReset = document.getElementById('dtl-reset');

function getTimelineForUI(){
  const arr = (Settings.data.defaultTimeline && Settings.data.defaultTimeline.length)
    ? Settings.data.defaultTimeline
    : DEFAULT_TIMELINE;
  // Return deep-ish copy for editing safety
  return arr.map(x => ({ name: x.name || 'Step', category: normalizeCategory(x.category || 'Task'), invoicePercent: (typeof x.invoicePercent !== 'undefined') ? Number(x.invoicePercent) : undefined }));
}

let dtlData = []; // working copy in UI
let dtlDragItem = null;

function buildDefaultTimelineList(){
  dtlData = getTimelineForUI();
  renderDTL();
}

function renderDTL(){
  dtlList.innerHTML='';
  if (!dtlData.length){
    const m = document.createElement('div');
    m.className = 'dtl-muted';
    m.textContent = 'No steps. Click ‚Äú+ Add Step‚Äù to get started.';
    dtlList.appendChild(m);
    return;
  }
  dtlData.forEach((row, idx)=>{
    const div = document.createElement('div');
    div.className = 'dtl-row';
    div.draggable = true;
    div.dataset.index = String(idx);
    div.innerHTML = `
      <span class="dtl-grab">‚ò∞</span>
      <input type="text" class="dtl-name" value="${row.name.replace(/"/g,'&quot;')}" />
      <select class="dtl-cat">
        <option value="Task"${row.category==='Task'?' selected':''}>Task</option>
        <option value="Invoice"${row.category==='Invoice'?' selected':''}>Invoice</option>
        <option value="External"${row.category==='External'?' selected':''}>External</option>
      </select>
      <input type="number" class="dtl-pct" min="0" max="100" step="1" placeholder="%" ${row.category==='Invoice'?'':'style="display:none;"'} value="${(typeof row.invoicePercent!=='undefined' && row.invoicePercent!==null)? row.invoicePercent : ''}"/>
      <div class="dtl-actions">
        <button class="btn-icon dtl-del">Delete</button>
      </div>
    `;
    const nameEl = div.querySelector('.dtl-name');
    const catEl = div.querySelector('.dtl-cat');
    const pctEl = div.querySelector('.dtl-pct');
    const delBtn = div.querySelector('.dtl-del');

    nameEl.addEventListener('input', ()=> { dtlData[idx].name = nameEl.value.trim() || 'Step'; });
    catEl.addEventListener('change', ()=> {
      dtlData[idx].category = normalizeCategory(catEl.value);
      if (dtlData[idx].category === 'Invoice') {
        pctEl.style.display = '';
      } else {
        pctEl.style.display = 'none';
        delete dtlData[idx].invoicePercent;
      }
    });
    pctEl.addEventListener('input', ()=> {
      const n = Number(pctEl.value);
      if (Number.isFinite(n)) dtlData[idx].invoicePercent = Math.max(0, Math.min(100, Math.round(n)));
    });
    delBtn.addEventListener('click', ()=>{
      dtlData.splice(idx,1);
      renderDTL();
    });

    // DnD
    div.addEventListener('dragstart', ()=>{ dtlDragItem = div; div.classList.add('dtl-ghost'); });
    div.addEventListener('dragend', ()=>{ div.classList.remove('dtl-ghost'); dtlDragItem = null; });
    div.addEventListener('dragover', (e)=>{
      e.preventDefault();
      if (!dtlDragItem || dtlDragItem===div) return;
      const list = dtlList;
      const rect = div.getBoundingClientRect();
      const mid = rect.top + rect.height/2;
      if (e.clientY < mid) list.insertBefore(dtlDragItem, div);
      else list.insertBefore(dtlDragItem, div.nextSibling);
    });

    dtlList.appendChild(div);
  });
}

function collectDTLFromDOM(){
  const rows = [...dtlList.querySelectorAll('.dtl-row')];
  const out = rows.map(r=>{
    const name = r.querySelector('.dtl-name').value.trim() || 'Step';
    const cat = normalizeCategory(r.querySelector('.dtl-cat').value || 'Task');
    const pctEl = r.querySelector('.dtl-pct');
    const pctRaw = pctEl && pctEl.style.display !== 'none' ? pctEl.value : '';
    const pct = pctRaw === '' ? undefined : Math.max(0, Math.min(100, Math.round(Number(pctRaw))));
    return { name, category: cat, ...(cat==='Invoice' ? { invoicePercent: pct } : {}) };
  });
  return out;
}

if (dtlAdd) dtlAdd.addEventListener('click', ()=>{
  dtlData.push({ name: 'New Step', category: 'Task' });
  renderDTL();
});
if (dtlReset) dtlReset.addEventListener('click', ()=>{
  if (!confirm('Reset Default Timeline to recommended steps?')) return;
  dtlData = DEFAULT_TIMELINE.map(x=>({ ...x }));
  renderDTL();
});

/* Open/Close Settings with tabs prepared */
function openSettings(){
  // Default active tab: Project Order
  activateTab('tab-order');

  // Populate invoice contacts
  setPrimaryName.value = Settings.data.primaryName || '';
  setPrimaryEmail.value = Settings.data.primaryEmail || '';
  setFinalName.value = Settings.data.finalName || '';
  setFinalEmail.value = Settings.data.finalEmail || '';

  // Risk
  setRiskGithub.value = Settings.data.riskGithubUrl || '';
  setRiskPattern.value = Settings.data.riskFileNamePattern || '';

  // Project order
  buildProjectOrderList();

  // Default timeline
  buildDefaultTimelineList();

  settingsBackdrop.style.display = 'flex';
}
function closeSettings(){ settingsBackdrop.style.display = 'none'; }
if (settingsBtn) settingsBtn.addEventListener('click', ()=> { if (!READ_ONLY) openSettings(); });
if (settingsClose) settingsClose.addEventListener('click', closeSettings);
if (settingsBackdrop) settingsBackdrop.addEventListener('click', e=>{ if(e.target===settingsBackdrop) closeSettings(); });

if (settingsSave) settingsSave.addEventListener('click', async ()=>{
  // Invoice contacts
  Settings.data.primaryName = setPrimaryName.value.trim() || 'Katie';
  Settings.data.primaryEmail = setPrimaryEmail.value.trim();
  Settings.data.finalName = setFinalName.value.trim() || 'Zach';
  Settings.data.finalEmail = setFinalEmail.value.trim() || 'zschuchardt@gogcg.com';

  // Risk
  Settings.data.riskGithubUrl = setRiskGithub.value.trim();
  Settings.data.riskFileNamePattern = setRiskPattern.value.trim() || '[Customer] [Project] Risk Assessment [YYYY-MM-DD].xlsm';

  // Project order
  const container = document.getElementById('project-container');
  const pidToProject = new Map([...container.querySelectorAll('.project')].map(p=>[p.dataset.pid, p]));
  const items = [...projOrderList.querySelectorAll('.re-item')];
  if (items.length){
    items.forEach(it=>{
      const p = pidToProject.get(it.dataset.pid);
      if (p) container.appendChild(p);
    });
    markDirty();
  }

  // Default Timeline
  Settings.data.defaultTimeline = collectDTLFromDOM();

  closeSettings();
  await saveToGoogle({silent:false});
  await loadFromGoogle({forceApply:true});
});

/* Unsaved-changes prompt */
window.addEventListener('beforeunload', (e)=>{
  if (READ_ONLY || !hasLocalEdits) return;
  e.preventDefault();
  e.returnValue = '';
});

/* -------- NEW: Assignments Report logic -------- */
const assnBackdrop = document.getElementById('assignments-backdrop');
const assnCloseBtn = document.getElementById('assignments-close');
const assnCloseBtn2 = document.getElementById('assn-close');
const assnOwnerChips = document.getElementById('assn-owner-chips');
const assnStatus = document.getElementById('assn-status');
const assnSearch = document.getElementById('assn-search');
const assnTbody = document.getElementById('assn-tbody');
const assnSummary = document.getElementById('assn-summary');
const assnCopy = document.getElementById('assn-copy');
const assnPrint = document.getElementById('assn-print');

let assnState = {
  owners: [],    // [{key,name}]
  selected: new Set(), // keys ‚Äî starts EMPTY by design
  rows: [],      // flattened rows
  status: 'open',
  query: ''
};

function canonicalOwnerListFromData(rows){
  const map = new Map();
  rows.forEach(r=>{
    const k = r.ownerKey;
    if (k || k==='') {
      if (!map.has(k)) map.set(k, r.owner || '(Unassigned)');
    }
  });
  return [...map.entries()]
    .map(([key, name])=>({key, name}))
    .sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
}

function gatherAssignmentData(){
  const rows=[];
  const projects = [...document.querySelectorAll('#project-container .project')];
  projects.forEach(project=>{
    const projName = project.querySelector('.project-header').childNodes[0].textContent.trim();
    const timeline = project.querySelector('.timeline');
    const tasks = [...timeline.querySelectorAll('.timeline-item')];

    tasks.forEach((task)=>{
      const taskName = task.querySelector('.task-name').textContent.trim();
      const baseHours = Number(task.dataset.baseHours||0);
      const subs = task._subtasks||[];
      const hasSubs = subs.length>0;

      // base row shown if baseHours>0 OR no subtasks (to represent standalone task work)
      if (baseHours>0 || !hasSubs) {
        const owner = (task.dataset.owner||'').trim();
        const ownerKey = owner ? owner.toLowerCase() : '';
        rows.push({
          ownerKey, owner: owner || '(Unassigned)',
          projName, projectElem: project,
          taskElem: task, taskName,
          subName: '‚Äî base ‚Äî',
          subIndex: -1,
          hours: baseHours,
          done: hasSubs ? null : (task.dataset.completed==='true'),
          hasSubs
        });
      }
      subs.forEach((st, sIndex)=>{
        const owner = (st.owner||'').trim();
        const ownerKey = owner ? owner.toLowerCase() : '';
        rows.push({
          ownerKey, owner: owner || '(Unassigned)',
          projName, projectElem: project,
          taskElem: task, taskName,
          subName: st.name || '',
          subIndex: sIndex,
          hours: Number(st.hours||0),
          done: !!st.done,
          hasSubs
        });
      });
    });
  });
  return rows;
}

function openAssignments(){
  // build state
  const rows = gatherAssignmentData();
  const owners = canonicalOwnerListFromData(rows);
  assnState.rows = rows;
  assnState.owners = owners;
  // Do NOT auto-select anyone. Start empty by design.
  assnState.status = assnStatus.value || 'open';
  assnState.query = (assnSearch.value||'').trim().toLowerCase();

  renderOwnerChips();
  renderAssignmentsTable();
  assnBackdrop.style.display = 'flex';
}
function closeAssignments(){ assnBackdrop.style.display = 'none'; }

function renderOwnerChips(){
  assnOwnerChips.innerHTML = '';
  // Quick-select controls
  const allChip = document.createElement('div');
  const activeKeys = assnState.owners.map(o=>o.key).filter(k => k !== ''); // exclude Unassigned ('' key)
  const isAll = assnState.selected.size === assnState.owners.length;
  const isAllActive = assnState.selected.size === activeKeys.length && activeKeys.every(k=>assnState.selected.has(k));

  allChip.className = 'assn-chip ' + (isAll ? 'active' : '');
  allChip.textContent = 'All';
  allChip.onclick = ()=>{
    if (assnState.owners.length === 0) return;
    if (isAll) {
      assnState.selected.clear(); // toggle off -> none
    } else {
      assnState.selected = new Set(assnState.owners.map(o=>o.key)); // select all including Unassigned
    }
    renderOwnerChips(); renderAssignmentsTable();
  };
  assnOwnerChips.appendChild(allChip);

  const allActiveChip = document.createElement('div');
  allActiveChip.className = 'assn-chip ' + (isAllActive ? 'active' : '');
  allActiveChip.textContent = 'All Active';
  allActiveChip.onclick = ()=>{
    if (activeKeys.length === 0) { assnState.selected.clear(); renderOwnerChips(); renderAssignmentsTable(); return; }
    if (isAllActive) {
      assnState.selected.clear(); // toggle off -> none
    } else {
      assnState.selected = new Set(activeKeys); // select all except Unassigned
    }
    renderOwnerChips(); renderAssignmentsTable();
  };
  assnOwnerChips.appendChild(allActiveChip);

  if (!assnState.owners.length){
    const span = document.createElement('span');
    span.textContent = 'No owners found.';
    span.style.fontSize = '12px';
    span.style.color = '#666';
    assnOwnerChips.appendChild(span);
    return;
  }

  // Individual owner chips (click to toggle; supports single-person views)
  assnState.owners.forEach(o=>{
    const chip = document.createElement('div');
    chip.className = 'assn-chip ' + (assnState.selected.has(o.key) ? 'active' : '');
    chip.textContent = o.name;
    chip.onclick = ()=>{
      if (assnState.selected.has(o.key)) assnState.selected.delete(o.key);
      else assnState.selected.add(o.key);
      renderOwnerChips(); renderAssignmentsTable();
    };
    assnOwnerChips.appendChild(chip);
  });
}

function rowMatchesFilters(r){
  // If nothing is selected, show nothing (blank view by default)
  if (assnState.selected.size === 0) return false;

  if (!assnState.selected.has(r.ownerKey)) return false;

  const q = assnState.query;
  if (q){
    const hay = `${r.owner} ${r.projName} ${r.taskName} ${r.subName}`.toLowerCase();
    if (!hay.includes(q)) return false;
  }

  const st = assnState.status;
  if (st === 'open') {
    // Treat base-row with hasSubs as "open" (no single checkbox to complete it)
    if (r.subIndex === -1 && r.hasSubs) return true;
    return r.done === false;
  } else if (st === 'completed') {
    // base-row with hasSubs has no own completion; exclude unless task complete with no subs
    if (r.subIndex === -1 && r.hasSubs) return false;
    return r.done === true;
  } else {
    return true; // all
  }
}

function renderAssignmentsTable(){
  assnTbody.innerHTML = '';
  const rows = assnState.rows.filter(rowMatchesFilters)
    .sort((a,b)=>{
      // sort by owner, then project, then task name, then subIndex
      const o = a.owner.localeCompare(b.owner, undefined, {sensitivity:'base'}); if (o) return o;
      const p = a.projName.localeCompare(b.projName, undefined, {sensitivity:'base'}); if (p) return p;
      const t = a.taskName.localeCompare(b.taskName, undefined, {sensitivity:'base'}); if (t) return t;
      return (a.subIndex - b.subIndex);
    });

  // Per-owner totals (visible only)
  const perOwner = new Map();
  let totalHours = 0;
  rows.forEach(r=>{
    perOwner.set(r.owner, (perOwner.get(r.owner)||0) + (Number(r.hours)||0));
    totalHours += (Number(r.hours)||0);
  });
  assnSummary.innerHTML = [...perOwner.entries()].map(([name,h])=>`<span><b>${name}:</b> ${h}</span>`).join(' ') + (rows.length ? ` <span><b>Total:</b> ${totalHours}</span>` : '');

  if (!rows.length){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 7;
    td.style.color = '#666';
    td.style.fontSize = '12px';
    td.textContent = 'No matching rows.';
    tr.appendChild(td);
    assnTbody.appendChild(tr);
    return;
  }

  rows.forEach(r=>{
    const tr = document.createElement('tr');

    const tdOwner = document.createElement('td'); tdOwner.textContent = r.owner;
    const tdProj  = document.createElement('td'); tdProj.textContent = r.projName;
    const tdTask  = document.createElement('td'); tdTask.textContent = r.taskName;
    const tdSub   = document.createElement('td'); tdSub.textContent  = r.subIndex>=0 ? r.subName : '‚Äî base ‚Äî';
    const tdHours = document.createElement('td'); tdHours.textContent = String(r.hours||0);

    const tdDone  = document.createElement('td');
    const cb = document.createElement('input'); cb.type = 'checkbox';
    if (r.subIndex === -1 && r.hasSubs) {
      cb.disabled = true; // base row with subtasks: completion controlled by subtasks
    } else {
      cb.checked = !!r.done;
      cb.disabled = READ_ONLY;
      cb.addEventListener('change', ()=>{
        if (READ_ONLY) return;
        if (r.subIndex>=0) {
          const st = r.taskElem._subtasks[r.subIndex];
          st.done = !!cb.checked;
          updateSubtaskHours(r.taskElem);
          updateCurrentIndicator(r.taskElem.closest('.timeline'));
          applyCompletionStyle(r.taskElem);
          markDirty();
        } else {
          setTaskComplete(r.taskElem, !!cb.checked);
        }
        // reflect new state
        assnState.rows = gatherAssignmentData();
        renderAssignmentsTable();
      });
    }
    tdDone.appendChild(cb);

    const tdActions = document.createElement('td');
    tdActions.className = 'assn-actions';

    const btnHours = document.createElement('button');
    btnHours.className = 'btn-icon';
    btnHours.textContent = '+ Hours';
    if (READ_ONLY) btnHours.disabled = true;
    btnHours.addEventListener('click', ()=>{
      if (READ_ONLY) return;
      const addRaw = prompt(`Add hours to ${r.subIndex>=0 ? 'subtask' : 'task base'}:`, '0');
      const add = Number(addRaw);
      if (!Number.isFinite(add) || add<=0) return;
      if (r.subIndex>=0) {
        const st = r.taskElem._subtasks[r.subIndex];
        st.hours = (Number(st.hours)||0) + add;
      } else {
        r.taskElem.dataset.baseHours = String((Number(r.taskElem.dataset.baseHours)||0) + add);
      }
      updateSubtaskHours(r.taskElem);
      updateCurrentIndicator(r.taskElem.closest('.timeline'));
      applyCompletionStyle(r.taskElem);
      markDirty();
      assnState.rows = gatherAssignmentData();
      renderAssignmentsTable();
    });

    const btnOwner = document.createElement('button');
    btnOwner.className = 'btn-icon';
    btnOwner.textContent = '‚úé Owner';
    if (READ_ONLY) btnOwner.disabled = true;
    btnOwner.addEventListener('click', ()=>{
      if (READ_ONLY) return;
      const cur = r.subIndex>=0 ? (r.taskElem._subtasks[r.subIndex].owner||'') : (r.taskElem.dataset.owner||'');
      const v = prompt('Owner name:', cur);
      if (v===null) return;
      if (r.subIndex>=0) {
        r.taskElem._subtasks[r.subIndex].owner = v.trim();
      } else {
        r.taskElem.dataset.owner = v.trim();
        updateTaskMetaDisplay(r.taskElem);
      }
      markDirty();
      assnState.rows = gatherAssignmentData();
      // Update meta for display
      updateSubtaskHours(r.taskElem);
      renderOwnerChips();
      renderAssignmentsTable();
    });

    const btnOpen = document.createElement('button');
    btnOpen.className = 'btn-icon';
    btnOpen.textContent = '‚ûú Open';
    btnOpen.addEventListener('click', ()=>{
      r.taskElem.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=> openSubtaskModal(r.taskElem), 250);
    });

    tdActions.appendChild(btnHours);
    tdActions.appendChild(btnOwner);
    tdActions.appendChild(btnOpen);

    tr.appendChild(tdOwner);
    tr.appendChild(tdProj);
    tr.appendChild(tdTask);
    tr.appendChild(tdSub);
    tr.appendChild(tdHours);
    tr.appendChild(tdDone);
    tr.appendChild(tdActions);

    assnTbody.appendChild(tr);
  });
}

function copyAssignmentsCSV(){
  const rows = assnState.rows.filter(rowMatchesFilters);
  const esc = s => `"${String(s).replace(/"/g,'""')}"`;
  const header = ['Owner','Project','Task','Subtask','Hours','Done'];
  const lines = [header.map(esc).join(',')];
  rows.forEach(r=>{
    lines.push([r.owner, r.projName, r.taskName, r.subIndex>=0 ? r.subName : '‚Äî base ‚Äî', r.hours||0, r.done===null ? '' : (r.done? 'TRUE':'FALSE')].map(esc).join(','));
  });
  const csv = lines.join('\n');
  navigator.clipboard.writeText(csv).then(()=> alert('Copied CSV for current view.'));
}
function printAssignmentsView(){
  const rows = assnState.rows.filter(rowMatchesFilters);
  const w = window.open('', '_blank');
  if (!w) { alert('Popup blocked.'); return; }
  const styles = `
    body { font-family: Arial, sans-serif; padding: 16px; }
    table { width:100%; border-collapse: collapse; font-size:12px; }
    th, td { border:1px solid #ddd; padding:6px 8px; text-align:left; }
    th { background:#f3f3f3; }
  `;
  w.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Assignments</title><style>'+styles+'</style></head><body>');
  w.document.write('<h3>Assignments</h3>');
  w.document.write('<table><thead><tr><th>Owner</th><th>Project</th><th>Task</th><th>Subtask</th><th>Hours</th><th>Done</th></tr></thead><tbody>');
  rows.forEach(r=>{
    w.document.write('<tr><td>'+r.owner+'</td><td>'+r.projName+'</td><td>'+r.taskName+'</td><td>'+(r.subIndex>=0 ? r.subName : '‚Äî base ‚Äî')+'</td><td>'+ (r.hours||0) +'</td><td>'+ (r.done===null ? '' : (r.done?'Yes':'No')) +'</td></tr>');
  });
  w.document.write('</tbody></table></body></html>');
  w.document.close();
  w.focus();
  w.print();
}

if (assignmentsBtn) assignmentsBtn.addEventListener('click', ()=> openAssignments());
assnCloseBtn.addEventListener('click', closeAssignments);
assnCloseBtn2.addEventListener('click', closeAssignments);
assnBackdrop.addEventListener('click', e=>{ if(e.target===assnBackdrop) openAssignments(); });
assnStatus.addEventListener('change', ()=>{ assnState.status = assnStatus.value; renderAssignmentsTable(); });
assnSearch.addEventListener('input', ()=>{ assnState.query = (assnSearch.value||'').trim().toLowerCase(); renderAssignmentsTable(); });
assnCopy.addEventListener('click', copyAssignmentsCSV);
assnPrint.addEventListener('click', printAssignmentsView);

/* Initial load */
(function init(){
  initTabs();

  if (READ_ONLY) {
    document.body.classList.add('ro');
    viewBadge.style.display = 'block';
    ['saveGoogleBtn','new-project-btn','settingsBtn'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) { el.style.display='none'; el.disabled = true; el.setAttribute('aria-hidden','true'); }
    });
  }

  showLoading(true);
  const overlayWatchdog = setTimeout(()=>{ showLoading(false); }, 12000);
  (async () => {
    try {
      await loadFromGoogle({forceApply:true});
      if (READ_ONLY) document.querySelectorAll('.edit-btn').forEach(b=>{ b.style.display='none'; b.disabled=true; });
      document.querySelectorAll('.timeline-item').forEach(updateTaskIcon);
    } catch (e) {
      console.error('Load failure:', e);
    } finally {
      clearTimeout(overlayWatchdog);
      showLoading(false);
    }
  })();
})();
</script>
</body>
</html>
